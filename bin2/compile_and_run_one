#!/bin/bash
set -eo pipefail

root="$( dirname "${BASH_SOURCE[0]}" )"/..
if [ -z "$llvmir" ]; then
    llvmir=$(mktemp -d)
    runfile=$(mktemp)
    rmtmp=1
fi

cleanup() {
    if [ -n "$rmtmp" ]; then
        rm -r "$llvmir" "$runfile"
    fi
}

trap cleanup EXIT

if [ -f main/sorbet ]; then
    sorbet=main/sorbet
    ld=external/llvm_toolchain/bin/ld
else
    cd "$root"
    bazel build @llvm_toolchain//:bin/ld main:sorbet 2> /dev/null
    cd - > /dev/null
    sorbet="$root/bazel-bin/main/sorbet"
    ld="$root/bazel-sorbet_llvm/external/llvm_toolchain/bin/ld"
fi

"$sorbet" --silence-dev-message --no-error-count --typed=true --llvm-ir-folder "$llvmir" "$@"

echo "require './$root/bin/preamble.rb';" > "$runfile"

for o in "$llvmir"/*.o; do
    bundle="${o%.rb}.bundle"
    "$ld" -bundle -o "$bundle" "$o" -undefined dynamic_lookup -macosx_version_min 10.14 -lSystem
    echo "require '$bundle';" >> "$runfile"
done

ruby="/Users/$(whoami)/.rbenv/shims/ruby"
$ruby "$runfile"
