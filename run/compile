#!/bin/bash
set -eo pipefail

base="$( dirname "${BASH_SOURCE[0]}" )"/..

if [ -f main/sorbet ]; then
    sorbet=main/sorbet
    ld=external/llvm_toolchain/bin/ld
else
    sorbet="$base/bazel-bin/main/sorbet"
    ld="$base/bazel-sorbet_llvm/external/llvm_toolchain/bin/ld"
    if [ ! -f "$sorbet" ]; then
        cd "$base"
        bazel build @llvm_toolchain//:bin/ld main:sorbet 2> /dev/null
        cd - > /dev/null
    fi
fi

llvmir=$1
rb=$2

"$sorbet" --silence-dev-message --no-error-count --llvm-ir-folder "$llvmir" "$rb"

for o in "$llvmir"/*.o; do
    bundle="${o%.o}.bundle"
    "$ld" -bundle -o "$bundle" "$o" -undefined dynamic_lookup -macosx_version_min 10.14 -lSystem
done
