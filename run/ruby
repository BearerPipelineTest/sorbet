#!/bin/bash
set -eo pipefail

root="$( dirname "${BASH_SOURCE[0]}" )"/..

if [ -z "$runfile" ]; then
    runfile=$(mktemp)
    rmtmp=1
fi

cleanup() {
    if [ -n "$rmtmp" ]; then
        rm -r "$runfile"
    fi
}

trap cleanup EXIT

echo "require './$root/run/preamble.rb';" > "$runfile"
echo "require './$root/run/patch_require.rb';" >> "$runfile"

for rb in "$@"; do
    echo "require '$rb';" >> "$runfile"
done

if [ -f external/ruby_2_6_3/ruby ]; then
    ruby=external/ruby_2_6_3/ruby
else
    bazel build @ruby_2_6_3//:ruby --config=dbg 2> /dev/null
    ruby="$root/bazel-bin/external/ruby_2_6_3/ruby"
fi
$ruby "$runfile"
