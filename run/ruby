#!/bin/bash
set -eo pipefail

root="$( dirname "${BASH_SOURCE[0]}" )"/..

if [ -z "$runfile" ]; then
    llvmir=$(mktemp -d)
    runfile=$(mktemp)
    rmtmp=1
fi

cleanup() {
    if [ -n "$rmtmp" ]; then
        rm -r "$llvmir" "$runfile"
    fi
}

trap cleanup EXIT

echo "require './$root/run/preamble.rb';" > "$runfile"
echo "require './$root/run/patch_require.rb';" >> "$runfile"

rb=$1
shift
echo "require '$rb';" >> "$runfile"
"$root/run/compile" "$llvmir" "$(dirname "$rb")"

if [ -f "$root/external/ruby_2_6_3/ruby" ]; then
    ruby="$root/external/ruby_2_6_3/ruby"
else
    cd "$root"
    bazel build @ruby_2_6_3//:ruby --config=dbg 2> /dev/null
    cd - > /dev/null
    ruby="$root/bazel-bin/external/ruby_2_6_3/ruby"
fi
$ruby "$runfile" "$@"
