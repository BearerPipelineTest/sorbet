#!/bin/bash
set -eo pipefail

base="$( cd "$(dirname "$0")" ; pwd -P )"/..

srbrunfile=$(mktemp)
cleanup() {
    rm -r "$srbrunfile"
}
trap cleanup EXIT

if [ -f "$base/external/sorbet_ruby/ruby" ]; then
    ruby="$base/external/sorbet_ruby/ruby"
else
    ruby="$base/bazel-bin/external/sorbet_ruby/ruby"
    if [ ! -f "$ruby" ]; then
        cd "$base"
        bazel build @sorbet_ruby//:ruby --config=dbg 2> /dev/null
        cd - > /dev/null
    fi
fi

rb=$1
shift

if [ "${rb:0:1}" != "/" ]; then
    rb="./$rb"
fi

echo "require '$rb';" > "$srbrunfile"
$ruby -r "$base/run/tools/preamble.rb" -r "$base/run/tools/patch_require.rb" "$srbrunfile" "$@"
