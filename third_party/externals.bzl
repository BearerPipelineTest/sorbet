load("@bazel_tools//tools/build_defs/repo:git.bzl", "git_repository", "new_git_repository")
load("@bazel_tools//tools/build_defs/repo:http.bzl", "http_archive")
load("//third_party:sorbet_version.bzl", "SORBET_SHALLOW_SINCE", "SORBET_VERSION")

# We define our externals here instead of directly in WORKSPACE
# because putting the `new_git_repository` calls here instead of there
# works around https://github.com/bazelbuild/bazel/issues/1465 when
# passing `build_file` to the `new_git_repository`.
def sorbet_llvm_externals():
    use_local = False
    if not use_local:
        git_repository(
            name = "com_stripe_ruby_typer",
            remote = "https://github.com/sorbet/sorbet.git",
            commit = SORBET_VERSION,
            shallow_since = SORBET_SHALLOW_SINCE,
        )
    else:
        native.local_repository(
            name = "com_stripe_ruby_typer",
            path = "../sorbet/",
        )

    http_archive(
        name = "llvm",
        url = "https://github.com/llvm/llvm-project/archive/f9f30f2ecba520fa1ce33ae7c27c807a0e7199be.tar.gz",
        build_file = "@com_stripe_sorbet_llvm//third_party/llvm:llvm.autogenerated.BUILD",
        sha256 = "36cdf1fad0d564248ed6a30ce825a8c86cdb7bca0923f3094173a188ee475c3c",
        strip_prefix = "llvm-project-f9f30f2ecba520fa1ce33ae7c27c807a0e7199be/llvm",
    )

    http_archive(
        name = "zlib_archive",
        url = "https://zlib.net/zlib-1.2.11.tar.gz",
        build_file = "@com_stripe_sorbet_llvm//third_party:zlib.BUILD",
        sha256 = "c3e5e9fdd5004dcb542feda5ee4f0ff0744628baf8ed2dd5d66f8ca1197cb1a1",
        strip_prefix = "zlib-1.2.11",
    )

    http_archive(
        name = "sorbet_ruby_2_6_3",
        url = "https://cache.ruby-lang.org/pub/ruby/2.6/ruby-2.6.3.tar.gz",
        sha256 = "577fd3795f22b8d91c1d4e6733637b0394d4082db659fccf224c774a2b1c82fb",
        strip_prefix = "ruby-2.6.3",
        build_file = "@com_stripe_sorbet_llvm//third_party/ruby:ruby-2.6.3.BUILD",
        patches = [
            "@com_stripe_sorbet_llvm//third_party/ruby:probes.h.patch",
            "@com_stripe_sorbet_llvm//third_party/ruby:enc.encinit.c.patch",
            "@com_stripe_sorbet_llvm//third_party/ruby:debug_counter.h.patch",
        ],
        patch_args = ["-p1"],
    )
